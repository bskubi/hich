nextflow_workflow {

    name "end to end"
    script "contents/hichWorkflow.nf"
    workflow "HichWorkflow"
    tag "10to60s"
    tag "e2e"

    test("SmokeTest_Stub_EndToEnd_LocalPC_MultiRep_Bulk") {
        config "$baseDir/tests/assets/config/nextflow.config"
        options """-profile localPC -stub-run -c $baseDir/tests/assets/params/default.config"""
        

        when {
            params {
                sampleFile = "$baseDir/tests/assets/sampleFile/akgol2021_hic3.0_2br_18tr.tsv"
            }
        }

        then {
            assert workflow.success
            with (workflow.out) {
                assert samples.size() == 21
                assert samples.findAll{it.aggregateLevel == "techrep"}.size() == 18
                assert samples.findAll{it.aggregateLevel == "biorep"}.size() == 2
                assert samples.findAll{it.aggregateLevel == "condition"}.size() == 1
                assert samples.findAll{it.containsKey("dedupPairs")}.size() == 20
                assert samples.every{
                    it.containsKey("hic") &&
                    it.containsKey("mcool") &&
                    it.containsKey("latestMatrix") &&
                    it.containsKey("latestPairs")
                }
            }
        }
    }
}