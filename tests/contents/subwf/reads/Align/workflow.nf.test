nextflow_workflow {

    name "Test Workflow Align"
    script "contents/subwf/reads/Align/workflow.nf"
    workflow "Align"
    
    test("SmokeTest_Align") {
        options """-profile localPC"""
        tag "3to10s"

        when {
            params {
                
            }
            workflow {
                """
                std1 = file("$projectDir/tests/assets/fastq/1k/1k_ERR1413593_1.fq.gz")
                std2 = file("$projectDir/tests/assets/fastq/1k/1k_ERR1413593_2.fq.gz")
                stdInterleaved = file("$projectDir/tests/assets/fastq/1k/1k_ERR1413593_interleaved.fq.gz")
                met1 = file("$projectDir/tests/assets/fastq/1k/1k_ERR1413593_1.fq.gz")
                met2 = file("$projectDir/tests/assets/fastq/1k/1k_ERR1413593_2.fq.gz")
                metInterleaved = file("$projectDir/tests/assets/fastq/1k/1k_ERR1413593_interleaved.fq.gz")
                common = [
                    datatype: "fastq",
                    minMapq: 30
                ]

                bwa = [aligner: "bwa", alignerIndexDir: file("$projectDir/tests/assets/index/bwa"), alignerIndexPrefix: "M129"]
                bwaMem2 = [aligner: "bwa-mem2", alignerIndexDir: file("$projectDir/tests/assets/index/bwa-mem2"), alignerIndexPrefix: "M129"]
                bwameth = [aligner: "bwameth", alignerIndexDir: file("$projectDir/tests/assets/index/bwameth"), alignerIndexPrefix: "M129"]
                bwamethMem2 = [aligner: "bwameth-mem2", alignerIndexDir: file("$projectDir/tests/assets/index/bwameth-mem2"), alignerIndexPrefix: "M129"]
                stdPaired = [fastq1: std1, fastq2: std2]
                stdSingle = [fastq: std1]
                stdInterleaved = [fastq: stdInterleaved]
                metPaired = [fastq1: met1, fastq2: met2]
                metSingle = [fastq: met1]
                metInterleaved = [fastq: metInterleaved]

                samples = [
                    common + bwa + stdPaired + [id: "1"],
                    common + bwa + stdSingle + [id: "2"],
                    common + bwa + stdInterleaved + [id: "3"],
                    common + bwaMem2 + stdPaired + [id: "4"],
                    common + bwaMem2 + stdSingle + [id: "5"],
                    common + bwaMem2 + stdInterleaved + [id: "6"],
                    /*
                    common + bwameth + metPaired + [id: "7"],
                    common + bwameth + metSingle + [id: "8"],
                    common + bwameth + metInterleaved + [id: "9"],
                    
                    common + bwamethMem2 + metPaired + [id: "10"],
                    common + bwamethMem2 + metSingle + [id: "11"],
                    common + bwamethMem2 + metInterleaved + [id: "12"]
                    */
                ]
                input[0] = channel.fromList(samples)
                """
            }
        }

        then {
            assert workflow.success
            /*
            with (workflow.out) {
                assert samples.size() == 12
                sambams = samples.collect{it.sambam.split("/")[-1]}

                assertContainsInAnyOrder(sambams, [
                    "1.bam",
                    "2.bam",
                    "3.bam",
                    "4.bam",
                    "5.bam",
                    "6.bam",
                    "7.bam",
                    "8.bam",
                    "9.bam",
                    "10.bam",
                    "11.bam",
                    "12.bam"
                ])
            }
            */
        }

    }

}
