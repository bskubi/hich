nextflow_workflow {

    name "Test Workflow DedupPairs"
    script "contents/subwf/aggregate/DedupPairs/workflow.nf"
    workflow "DedupPairs"

    test("SmokeTest_DedupPairs") {
        tag "priority1"

        when {
            params {}
            workflow {
                """
                pairs = file("$projectDir/tests/assets/pairs/1k/1k_Formaldehyde+DSG_DdeI_and_DpnII_HFFc6_BR1_TR1.drop.pairs.gz")

                dedupSamples = [
                    [id: "1", latestPairs: pairs, aggregateLevel: "techrep"],
                    [id: "2", latestPairs: pairs, aggregateLevel: "biorep"],
                    [id: "3", latestPairs: pairs, aggregateLevel: "techrep"],
                    [id: "4", latestPairs: pairs, aggregateLevel: "techrep", dedupMaxMismatch: 0],
                    [id: "5", latestPairs: pairs, aggregateLevel: "techrep", dedupMethod: "sum"]
                ]
                ignoreSamples = [
                    [id: "6", latestPairs: pairs, aggregateLevel: "condition"],
                    [id: "7", latestPairs: pairs, skipDedup: true],
                    [id: "8", latestPairs: pairs, aggregateLevel: "techrep", skipDedupTechreps: true],
                    [id: "9", latestPairs: pairs, aggregateLevel: "biorep", skipDedupBioreps: true],
                    [id: "10", latestPairs: pairs, aggregateLevel: "biorep", skipDedup: true]
                ]

                samples = dedupSamples + ignoreSamples

                input[0] = channel.fromList(samples)
                """
            }
        }

        then {
            assert workflow.success
            with (workflow.out) {
                assert samples.size() == 10
                def dedupPairs = samples.collect{it.dedupPairs}.findAll{it}
                assert dedupPairs.size() == 5
            }
        }

    }

}
